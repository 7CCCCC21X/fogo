<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>排行榜汇总</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #fafafa; }
    h1, h2 { text-align: center; color: #333; }
    .tab-nav { text-align: center; margin-bottom: 20px; }
    .tab-nav button { padding: 8px 16px; margin: 0 4px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; background: #f0f0f0; }
    .tab-nav button.active { background-color: #007bff; color: white; }
    .leaderboard-section { display: none; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    #searchBox { text-align: center; margin: 20px 0; }
    #searchBox textarea { width: 500px; height: 120px; padding: 8px; font-size: 14px; }
    #searchBox button { margin-left: 8px; padding: 8px 16px; font-size: 14px; }
    .trend-row { display: none; background: #f9f9f9; }
    .trend-cell { padding: 16px; }
    #authorLink { margin-top: 30px; text-align: center; font-size: 14px; }
  </style>
</head>
<body>
  <h1>排行榜汇总</h1>
  <div class="tab-nav">
    <button class="tab-btn active" data-target="tradingSection">TRADING</button>
    <button class="tab-btn" data-target="stakingSection">STAKING</button>
    <button class="tab-btn" data-target="discordSection">DISCORD</button>
    <button class="tab-btn" data-target="xcomSection">X.COM</button>
  </div>

  <div id="searchBox">
    <textarea id="queryInput" placeholder="每行输入一个地址进行查询..."></textarea>
    <button onclick="filterCurrentTable()">查询</button>
  </div>

  <section id="tradingSection" class="leaderboard-section">
    <h2>TRADING 排行榜</h2>
    <table id="tradingTable">
      <thead><tr><th>排名</th><th>地址</th><th>上周</th><th>本周</th><th>积分变化</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="stakingSection" class="leaderboard-section">
    <h2>STAKING 排行榜</h2>
    <table id="stakingTable">
      <thead><tr><th>排名</th><th>地址</th><th>上周</th><th>本周</th><th>积分变化</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="discordSection" class="leaderboard-section">
    <h2>DISCORD 排行榜</h2>
    <table id="discordTable">
      <thead><tr><th>排名</th><th>地址</th><th>上周</th><th>本周</th><th>积分变化</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="xcomSection" class="leaderboard-section">
    <h2>X.COM 排行榜</h2>
    <table id="xcomTable">
      <thead><tr><th>排名</th><th>地址</th><th>上周</th><th>本周</th><th>积分变化</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <div id="authorLink">作者：<a href="https://x.com/0xXIAOc" target="_blank">小C</a></div>

  <script>
    const lineRegex = /排名:\s*(\d+)\s*,\s*地址:\s*([^,]+)\s*,\s*分数:\s*(\d+)/;

    async function loadWeekData(file) {
      try {
        const res = await fetch(file);
        const text = await res.text();
        const map = {};
        text.trim().split('\n').forEach(line => {
          const m = line.match(lineRegex);
          if (m) map[m[2].toLowerCase()] = parseFloat(m[3]);
        });
        return map;
      } catch {
        return {};
      }
    }

    async function loadLeaderboard(type) {
      const current = await loadWeekData(`data/${type}.txt`);
      const last = await loadWeekData(`data/${type}-week1.txt`);
      const table = document.querySelector(`#${type}Table tbody`);
      table.innerHTML = '';
      let rank = 1;
      Object.entries(current).forEach(([addr, now]) => {
        const prev = last[addr] || 0;
        const diff = now - prev;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${rank++}</td><td>${addr}</td><td>${prev}</td><td>${now}</td><td class="diff-cell" style="cursor:pointer;color:${diff>=0?'green':'red'}">${diff>=0?'+':''}${diff}</td>`;
        table.appendChild(tr);

        const trendRow = document.createElement('tr');
        trendRow.className = 'trend-row';
        const trendCell = document.createElement('td');
        trendCell.colSpan = 5;
        trendCell.className = 'trend-cell';
        trendCell.innerHTML = `<canvas id="trend-${type}-${addr.slice(2, 10)}" height="150"></canvas>`;
        trendRow.appendChild(trendCell);
        table.appendChild(trendRow);

        tr.querySelector('.diff-cell').addEventListener('click', () => {
          const canvasId = `trend-${type}-${addr.slice(2, 10)}`;
          trendRow.style.display = trendRow.style.display === 'table-row' ? 'none' : 'table-row';
          drawTrendChart(addr, type, canvasId);
        });
      });
    }

    async function drawTrendChart(address, category, canvasId) {
      const weeks = ['week5', 'week4', 'week3', 'week2', 'week1', '本周'];
      const labels = ['week5', 'week4', 'week3', 'week2', 'week1'];
      const score = [];
      for (let w of labels) {
        const m = await loadWeekData(`data/${category}-${w}.txt`);
        score.push(m[address.toLowerCase()] || 0);
      }
      const m = await loadWeekData(`data/${category}.txt`);
      score.push(m[address.toLowerCase()] || 0);

      const ctx = document.getElementById(canvasId)?.getContext('2d');
      if (!ctx) return;
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['W5', 'W4', 'W3', 'W2', 'W1', '本周'],
          datasets: [{
            label: '积分变化',
            data: score,
            borderWidth: 2,
            tension: 0.2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function filterCurrentTable() {
      const input = document.getElementById('queryInput').value.toLowerCase().split('\n').filter(Boolean);
      const section = Array.from(document.querySelectorAll('.leaderboard-section')).find(s => s.style.display !== 'none');
      if (!section) return;
      const rows = section.querySelectorAll('tbody tr');
      for (let i = 0; i < rows.length; i += 2) {
        const dataRow = rows[i];
        const trendRow = rows[i + 1];
        const addr = dataRow.children[1]?.textContent.toLowerCase();
        const match = input.length === 0 || input.includes(addr);
        dataRow.style.display = trendRow.style.display = match ? '' : 'none';
      }
    }

    // tab切换逻辑
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const targetId = btn.dataset.target;
        document.querySelectorAll('.leaderboard-section').forEach(sec => sec.style.display = 'none');
        document.getElementById(targetId).style.display = 'block';
        loadLeaderboard(targetId.replace('Section', ''));
      }
    });

    // 默认显示 tradingSection
    document.getElementById('tradingSection').style.display = 'block';
    loadLeaderboard('trading');
  </script>
</body>
</html>
