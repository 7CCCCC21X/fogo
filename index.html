<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æ’è¡Œæ¦œæ±‡æ€»</title>

<!-- Chart.js & Sparklineï¼ˆåŒç”¨ Chart.jsï¼Œä½“ç§¯ 6Â KB gzipï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#fafafa; --text:#333; --card:#fff; --border:#ccc; --accent:#0066cc;
  --pos:#28a745; --neg:#e55353; --th:#f5f5f5;
}
[data-theme=dark]{
  --bg:#1e1e1e; --text:#d6d6d6; --card:#2b2b2b; --border:#555; --accent:#3399ff;
  --pos:#3bd26f; --neg:#ff7070; --th:#333;
}

/* â€”â€” åŸºç¡€ â€”â€” */
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
     background:var(--bg);color:var(--text);transition:.3s;}
.container{max-width:1200px;margin:0 auto;padding:20px;}
h1,h2{text-align:center;margin:.3em 0;color:var(--text);}

/* â€”â€” Tab â€”â€” */
.tab-nav{text-align:center;margin-bottom:15px;overflow-x:auto;white-space:nowrap}
.tab-nav button{padding:8px 18px;margin:0 4px;border:none;border-radius:4px;
                background:var(--th);cursor:pointer;font-size:14px;transition:.3s}
.tab-nav button.active{background:var(--accent);color:#fff}

/* â€”â€” æ“ä½œæ  â€”â€” */
.toolbar{text-align:center;margin-bottom:15px}
textarea{width:500px;max-width:100%;height:160px;padding:8px;font-size:14px;
         resize:both;background:var(--card);color:var(--text);border:1px solid var(--border);}
.toolbar button{padding:8px 16px;border:none;border-radius:4px;font-size:14px;cursor:pointer;color:#fff}
#queryBtn{background:var(--accent);margin-right:6px}
#exportBtn{background:#4caf50}

/* â€” è¡¨æ ¼å®¹å™¨ï¼šæ‰‹æœºç«¯æ¨ªå‘æ»‘åŠ¨ â€” */
.table-wrap{overflow-x:auto}
table{width:100%;min-width:600px;border-collapse:collapse;margin-bottom:25px;background:var(--card)}
th,td{border:1px solid var(--border);padding:6px 8px;text-align:center;font-size:14px}
th{background:var(--th);position:sticky;top:0;z-index:2;cursor:pointer;user-select:none}
th.sort-asc::after{content:" â–²";font-size:11px}
th.sort-desc::after{content:" â–¼";font-size:11px}
.no-data td{color:#999;font-style:italic}
tr:hover{background:rgba(0,0,0,.04)}

/* â€”â€” diff é¢œè‰² â€”â€” */
.diff-pos{color:var(--pos);font-weight:bold}
.diff-neg{color:var(--neg);font-weight:bold}

/* â€”â€” Sparkline â€”â€” */
.spark{width:60px;height:22px}

/* â€”â€” æŒ‡æ ‡å¼€å…³ â€”â€” */
#colSwitch{margin:10px 0;text-align:center;font-size:13px}
#colSwitch label{margin:0 8px;cursor:pointer}

/* â€”â€” æ·±è‰²æŒ‰é’® â€”â€” */
#themeToggle{position:fixed;top:15px;right:15px;background:none;border:none;
             font-size:22px;cursor:pointer;color:var(--accent)}

/* â€”â€” åŠ¨æ•ˆ â€”â€” */
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.section{animation:fadeIn .3s both}
</style>
</head>
<body>

<button id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>

<div class="container">
  <h1>æ’è¡Œæ¦œæ±‡æ€»</h1>

  <!-- Tab -->
  <div class="tab-nav">
    <button data-target="trading" class="tab-btn active">TRADING</button>
    <button data-target="staking"  class="tab-btn">STAKING</button>
    <button data-target="discord"  class="tab-btn">DISCORD</button>
    <button data-target="xcom"     class="tab-btn">X.COM</button>
    <button data-target="stats"    class="tab-btn">æ±‡æ€»</button>
  </div>

  <!-- æ“ä½œæ ï¼ˆæœç´¢ + å¯¼å‡ºï¼‰ -->
  <div class="toolbar" id="toolbar">
    <textarea id="queryInput" placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªåœ°å€â€¦"></textarea><br>
    <button id="queryBtn">æŸ¥è¯¢</button>
    <button id="exportBtn">å¯¼å‡º CSV</button>
  </div>

  <!-- å››å¼ æ¦œå• -->
  <div id="trading" class="section">
    <h2>TRADING</h2>
    <div class="table-wrap">
      <table id="tradingTable"><thead><tr>
        <th>æ’å</th><th>åœ°å€</th><th>æœ¬å‘¨åˆ†æ•°</th><th>ä¸Šå‘¨åˆ†æ•°</th><th>å˜åŒ–</th><th>%</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="staking" class="section" style="display:none">
    <h2>STAKING</h2>
    <div class="table-wrap">
      <table id="stakingTable"><thead><tr>
        <th>æ’å</th><th>åœ°å€</th><th>æœ¬å‘¨åˆ†æ•°</th><th>ä¸Šå‘¨åˆ†æ•°</th><th>å˜åŒ–</th><th>%</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="discord" class="section" style="display:none">
    <h2>DISCORD</h2>
    <div class="table-wrap">
      <table id="discordTable"><thead><tr>
        <th>æ’å</th><th>åœ°å€</th><th>æœ¬å‘¨åˆ†æ•°</th><th>ä¸Šå‘¨åˆ†æ•°</th><th>å˜åŒ–</th><th>%</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="xcom" class="section" style="display:none">
    <h2>X.COM</h2>
    <div class="table-wrap">
      <table id="xcomTable"><thead><tr>
        <th>æ’å</th><th>åœ°å€</th><th>æœ¬å‘¨åˆ†æ•°</th><th>ä¸Šå‘¨åˆ†æ•°</th><th>å˜åŒ–</th><th>%</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- æ±‡æ€» -->
  <div id="stats" class="section" style="display:none">
    <h2>æ±‡æ€»æ•°æ®</h2>
    <p style="text-align:center;font-size:14px;color:#888">ç”¨æˆ·æ•°é‡ = åœ°å€æ•°ï¼›æ€»åˆ† = æœ¬å‘¨åˆ†æ•°ä¹‹å’Œ</p>

    <!-- æŒ‡æ ‡åˆ—å¼€å…³ -->
    <div id="colSwitch">
      <label><input type="checkbox" checked data-col="2">æœ¬å‘¨</label>
      <label><input type="checkbox" checked data-col="3">ä¸Šå‘¨</label>
      <label><input type="checkbox" checked data-col="4">å˜åŒ–</label>
      <label><input type="checkbox" checked data-col="5">%</label>
      <label><input type="checkbox" checked data-col="6">è¶‹åŠ¿</label>
    </div>

    <div class="table-wrap">
      <table id="statsTable"><thead></thead><tbody></tbody></table>
    </div>

    <canvas id="trendChart" height="120"></canvas>
  </div>

  <div style="text-align:center;margin-top:18px;font-size:15px">
    ä½œè€…ï¼š<a href="https://x.com/0xXIAOc" target="_blank">å°C</a>
  </div>
</div>

<script>
/* ---------- å¸¸é‡ ---------- */
const boards = {
  trading : ['data/trading.txt','data/trading-week1.txt','tradingTable','trading'],
  staking : ['data/staking.txt','data/staking-week1.txt','stakingTable','staking'],
  discord : ['data/discord.txt','data/discord-week1.txt','discordTable','discord'],
  xcom    : ['data/xcom.txt','data/xcom.week1.txt', 'xcomTable',   'xcom'] // â† å·²æ”¹ â€œç‚¹å·â€
};
const lineRe=/æ’å:\s*(\d+)\s*,\s*åœ°å€:\s*([^,]+)\s*,\s*åˆ†æ•°:\s*(\d+)/;

/* ---------- ç¼“å­˜ ---------- */
const loaded={};         // {board:true}
let trendChart=null;

/* ---------- å·¥å…· ---------- */
const nf = n=>Number(n).toLocaleString('en-US');

/* ---------- æ·±è‰²ä¸»é¢˜ ---------- */
const themeBtn=document.getElementById('themeToggle');
themeBtn.onclick=()=>{
  const dark=document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme',dark?'':'dark');
  themeBtn.textContent=dark?'ğŸŒ™':'â˜€ï¸';
};

/* ---------- è§£æ / æ¸²æŸ“ ---------- */
async function loadBoard(board){
  if(loaded[board]) return;
  const [curPath,prevPath,tableId,type]=boards[board];

  // fetch
  const [curRes,prevRes]=await Promise.all([fetch(curPath),fetch(prevPath)]);
  if(!curRes.ok){alert(`${curPath} åŠ è½½å¤±è´¥`);return}
  const curTxt=await curRes.text();
  const prevTxt=prevRes.ok?await prevRes.text():'';
  const prevMap=new Map();
  prevTxt.trim().split('\n').forEach(l=>{
    const m=l.match(lineRe); if(m) prevMap.set(m[2].toLowerCase(),+m[3]);
  });

  const tbody=document.getElementById(tableId).querySelector('tbody');
  tbody.innerHTML='';
  const frag=document.createDocumentFragment();

  curTxt.trim().split('\n').forEach(l=>{
    const m=l.match(lineRe); if(!m) return;
    const rank=m[1],addr=m[2],cur=+m[3],prev=prevMap.get(addr.toLowerCase())??null;
    const diff = prev!==null?cur-prev:null;
    const pct  = prev? ((diff/prev)*100).toFixed(2):null;

    const tr=document.createElement('tr');
    tr.insertCell().textContent=rank;
    const tdAddr=tr.insertCell();
    if(type==='discord'){tdAddr.textContent=addr;}
    else{
      const a=document.createElement('a');a.textContent=addr;a.target='_blank';
      if(type==='trading') a.href='https://debank.com/profile/'+addr;
      if(type==='staking') a.href='https://app.getnimbus.io/?tab=token&type=SOL&chain=ALL&address='+addr;
      if(type==='xcom')    a.href='https://x.com/'+addr;
      tdAddr.appendChild(a);
    }
    tr.insertCell().textContent=nf(cur);
    tr.insertCell().textContent=prev!==null?nf(prev):'â€”';

    const tdDiff=tr.insertCell();
    if(diff===null){tdDiff.textContent='â€”';}
    else{
      tdDiff.textContent=`${diff>0?'â–²':'â–¼'} ${nf(Math.abs(diff))}`;
      tdDiff.className=diff>0?'diff-pos':'diff-neg';
    }

    tr.insertCell().textContent = pct!==null?`${diff>0?'+':''}${pct}%`:'â€”';
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);
  addSorter(tableId,1);   // æ’ååˆ—å¤–ï¼Œä» 2 å¼€å§‹å¯æ’åº
  loaded[board]=true;
  buildStats();           // æ¯æ¬¡åŠ è½½å®Œåˆ·æ–°æ±‡æ€»
}

/* ---------- æ’åº ---------- */
function addSorter(tableId,skipIndex=0){
  const ths=[...document.querySelector(`#${tableId} thead`).rows[0].cells];
  ths.forEach((th,i)=>{
    if(i<=skipIndex) return;
    th.onclick=()=>{
      const dir = th.classList.contains('sort-asc')?'desc':'asc';
      ths.forEach(t=>t.classList.remove('sort-asc','sort-desc'));
      th.classList.add(dir==='asc'?'sort-asc':'sort-desc');

      const rows=[...document.querySelector(`#${tableId} tbody`).rows];
      rows.sort((a,b)=>{
        const va=parseFloat(a.cells[i].textContent.replace(/,/g,''))||0;
        const vb=parseFloat(b.cells[i].textContent.replace(/,/g,''))||0;
        return dir==='asc'?va-vb:vb-va;
      });
      const frag=document.createDocumentFragment();
      rows.forEach(r=>frag.appendChild(r));
      document.querySelector(`#${tableId} tbody`).appendChild(frag);
    };
  });
}

/* ---------- æ±‡æ€» & è¶‹åŠ¿ + sparkline ---------- */
function buildStats(){
  const statsBody=document.querySelector('#statsTable tbody');
  const statsHead=document.querySelector('#statsTable thead');
  statsHead.innerHTML='<tr><th>æ’è¡Œæ¦œ</th><th>ç”¨æˆ·</th><th>æœ¬å‘¨</th><th>ä¸Šå‘¨</th><th>å˜åŒ–</th><th>%</th><th>è¶‹åŠ¿</th></tr>';
  statsBody.innerHTML='';
  let totalCur=0,totalPrev=0,totalUsers=0;
  const rowsData=[];  // ç”¨äºæŠ˜çº¿å›¾

  Object.entries(boards).forEach(([board,[,,tableId]])=>{
    if(!loaded[board]) return;
    const trs=[...document.querySelector(`#${tableId} tbody`).rows];
    if(trs.length===0) return;
    const users=trs.length;
    const sumCur=trs.reduce((s,r)=>s+(+r.cells[2].textContent.replace(/,/g,'')),0);
    const sumPrev=trs.reduce((s,r)=>s+ (+r.cells[3].textContent.replace(/,/g,'')),0);
    const diff=sumCur-sumPrev;
    const pct=sumPrev?((diff/sumPrev)*100).toFixed(2):0;

    // è¡Œ
    const tr=document.createElement('tr');
    tr.insertCell().textContent=board.toUpperCase();
    tr.insertCell().textContent=nf(users);
    tr.insertCell().textContent=nf(sumCur);
    tr.insertCell().textContent=nf(sumPrev);
    const tdDiff=tr.insertCell(); tdDiff.textContent=nf(diff);
    tdDiff.className=diff>0?'diff-pos':diff<0?'diff-neg':'';
    const tdPct=tr.insertCell();  tdPct.textContent=`${diff>0?'+':''}${pct}%`;
    tdPct.className=diff>0?'diff-pos':diff<0?'diff-neg':'';

    // sparkline
    const tdSpark=tr.insertCell();
    const c=document.createElement('canvas');c.className='spark';
    tdSpark.appendChild(c);
    new Chart(c,{type:'line',
      data:{labels:['ä¸Šå‘¨','æœ¬å‘¨'],datasets:[{data:[sumPrev,sumCur]}]},
      options:{plugins:{legend:{display:false}},elements:{line:{tension:0.3,borderWidth:1},
               point:{radius:0}},scales:{x:{display:false},y:{display:false}}}
    });

    statsBody.appendChild(tr);

    totalCur+=sumCur; totalPrev+=sumPrev; totalUsers+=users;
    rowsData.push({board,sumCur,sumPrev});
  });

  // totals
  const diffTotal=totalCur-totalPrev;
  const pctTotal=totalPrev?((diffTotal/totalPrev)*100).toFixed(2):0;
  const trT=document.createElement('tr');trT.style.fontWeight='bold';
  trT.innerHTML=`
    <td>æ€»è®¡</td>
    <td>${nf(totalUsers)}</td>
    <td>${nf(totalCur)}</td>
    <td>${nf(totalPrev)}</td>
    <td class="${diffTotal>0?'diff-pos':diffTotal<0?'diff-neg':''}">${nf(diffTotal)}</td>
    <td class="${diffTotal>0?'diff-pos':diffTotal<0?'diff-neg':''}">${diffTotal>0?'+':''}${pctTotal}%</td>
    <td></td>`;
  statsBody.appendChild(trT);

  // summary sorter
  addSorter('statsTable');

  // trend lines
  const ctx=document.getElementById('trendChart').getContext('2d');
  if(trendChart) trendChart.destroy();
  trendChart=new Chart(ctx,{
    type:'line',
    data:{labels:rowsData.map(r=>r.board.toUpperCase()),
          datasets:[
            {label:'æœ¬å‘¨',data:rowsData.map(r=>r.sumCur)},
            {label:'ä¸Šå‘¨',data:rowsData.map(r=>r.sumPrev)}
          ]},
    options:{responsive:true,plugins:{legend:{display:true}},
             elements:{line:{tension:.3},point:{radius:3}}}
  });
}

/* ---------- æŒ‡æ ‡åˆ—å¼€å…³ ---------- */
document.querySelectorAll('#colSwitch input').forEach(ch=>{
  ch.onchange=()=>{
    const col=+ch.dataset.col;
    [...document.querySelectorAll(`#statsTable tr`)].forEach(r=>{
      if(r.cells[col]) r.cells[col].style.display=ch.checked?'':'none';
    });
  };
});

/* ---------- å¯¼å‡º CSV ---------- */
document.getElementById('exportBtn').onclick=()=>{
  const visibleSection=[...document.querySelectorAll('.section')]
                       .find(s=>s.style.display!=='none');
  const table=visibleSection.querySelector('table');
  if(!table){alert('å½“å‰é¡µé¢æ²¡æœ‰è¡¨æ ¼');return;}
  const rows=[...table.rows].map(r=>
       [...r.cells].map(c=>`"${c.textContent.replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([rows],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`${visibleSection.id}.csv`;
  a.click();
  URL.revokeObjectURL(url);
};

/* ---------- æœç´¢ ---------- */
document.getElementById('queryBtn').onclick=()=>{
  const term=document.getElementById('queryInput').value.trim().toLowerCase();
  const visible=[...document.querySelectorAll('.section')]
                .find(s=>s.style.display!=='none'&&s.id!=='stats');
  if(!visible) return;
  const rows=[...visible.querySelectorAll('tbody tr')];
  if(!term){rows.forEach(r=>r.style.display='');return;}
  const keys=term.split('\n').map(s=>s.trim()).filter(Boolean);
  rows.forEach(r=>{
    const show=keys.some(k=>r.textContent.toLowerCase().includes(k));
    r.style.display=show?'':'none';
  });
};

/* ---------- Tab åˆ‡æ¢ ---------- */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.onclick=async()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const target=btn.dataset.target;
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById(target).style.display='block';
    // å·¥å…·æ æ˜¾éš
    document.getElementById('toolbar').style.display=target==='stats'?'none':'block';
    // æ‡’åŠ è½½
    if(boards[target]) await loadBoard(target);
  };
});

/* ---------- é¦–å±åŠ è½½ trading ---------- */
loadBoard('trading');
</script>
</body>
</html>
