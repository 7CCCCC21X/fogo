<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>排行榜汇总</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1, h2 {
      color: #333;
    }
    .tab-nav {
      margin-bottom: 20px;
    }
    .tab-nav button {
      padding: 10px 20px;
      margin-right: 10px;
      border: none;
      background-color: #f5f5f5;
      cursor: pointer;
      border-radius: 4px;
    }
    .tab-nav button.active {
      background-color: #0066cc;
      color: white;
    }
    .search-box {
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f5f5f5;
    }
    .no-data td {
      color: #999;
      font-style: italic;
    }
    /* 默认隐藏所有排行榜 */
    .leaderboard-section {
      display: none;
    }
    /* 统计区域样式 */
    #statsSection {
      margin-top: 30px;
      font-weight: bold;
      font-size: 16px;
    }
    #statsSection table {
      width: auto;
      border-collapse: collapse;
      margin: 0 auto;
    }
    #statsSection th, #statsSection td {
      border: 1px solid #ccc;
      padding: 6px 12px;
      text-align: center;
    }
    #statsSection th {
      background-color: #eee;
    }
    /* 单独的作者链接展示 */
    #authorLink {
      margin-top: 20px;
      font-size: 15px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>排行榜汇总</h1>

  <!-- 选项卡导航：包含四个排行榜及“汇总” -->
  <div class="tab-nav">
    <button data-target="tradingSection" class="tab-btn active">TRADING</button>
    <button data-target="stakingSection" class="tab-btn">STAKING</button>
    <button data-target="discordSection" class="tab-btn">DISCORD</button>
    <button data-target="xcomSection" class="tab-btn">X.COM</button>
    <button data-target="statsSection" class="tab-btn">汇总</button>
  </div>

  <!-- 批量查询（仅针对当前显示的排行榜） -->
  <div class="search-box">
    <input type="text" id="queryInput" placeholder="请输入地址或关键词查询..." style="width:300px; padding:8px;">
    <button onclick="filterCurrentTable()">查询</button>
  </div>

  <!-- TRADING 排行榜 -->
  <section id="tradingSection" class="leaderboard-section">
    <h2>TRADING</h2>
    <table id="tradingTable">
      <thead>
        <tr>
          <th>排名</th>
          <th>地址</th>
          <th>分数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- STAKING 排行榜 -->
  <section id="stakingSection" class="leaderboard-section">
    <h2>STAKING</h2>
    <table id="stakingTable">
      <thead>
        <tr>
          <th>排名</th>
          <th>地址</th>
          <th>分数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- DISCORD 排行榜 -->
  <section id="discordSection" class="leaderboard-section">
    <h2>DISCORD</h2>
    <table id="discordTable">
      <thead>
        <tr>
          <th>排名</th>
          <th>地址</th>
          <th>分数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- X.COM 排行榜 -->
  <section id="xcomSection" class="leaderboard-section">
    <h2>X.COM</h2>
    <table id="xcomTable">
      <thead>
        <tr>
          <th>排名</th>
          <th>地址</th>
          <th>分数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 汇总数据区域 -->
  <section id="statsSection" class="leaderboard-section">
    <h2>汇总数据</h2>
    <div id="statsContent" style="font-weight: bold; font-size: 16px;"></div>
  </section>

  <!-- 单独的作者链接展示 -->
  <div id="authorLink">
    作者：<a href="https://x.com/0xXIAOc" target="_blank">小C</a>
  </div>

  <script>
    /**
     * 数据文件格式示例：
     * 排名: 1, 地址: 0x9ed15383940cc380faef0a75edace507cc775f22, 分数: 42000
     */
    const lineRegex = /排名:\s*(\d+)\s*,\s*地址:\s*([^,]+)\s*,\s*分数:\s*(\d+)/;

    // 加载单个排行榜数据，type 参数用于判断跳转链接
    async function loadLeaderboard(filePath, tableId, type) {
      try {
        const response = await fetch(filePath);
        if (!response.ok) {
          throw new Error('无法加载 ' + filePath);
        }
        const text = await response.text();
        const lines = text.trim().split('\n');
        const tbody = document.getElementById(tableId).querySelector('tbody');
        tbody.innerHTML = ''; // 清空原有数据

        lines.forEach(line => {
          const match = line.match(lineRegex);
          if (match) {
            const rank = match[1];
            const address = match[2];
            const score = parseFloat(match[3]);

            const tr = document.createElement('tr');

            // 排名
            const tdRank = document.createElement('td');
            tdRank.textContent = rank;
            tr.appendChild(tdRank);

            // 地址
            const tdAddress = document.createElement('td');
            // 对于 DISCORD，直接使用文本显示地址；其他的创建超链接
            if (type === 'discord') {
              tdAddress.textContent = address;
            } else {
              const link = document.createElement('a');
              link.textContent = address;
              link.target = "_blank";
              if (type === 'trading') {
                link.href = 'https://debank.com/profile/' + address;
              } else if (type === 'staking') {
                link.href = 'https://app.getnimbus.io/?tab=token&type=SOL&chain=ALL&address=' + address;
              } else if (type === 'xcom') {
                link.href = 'https://x.com/' + address;
              } else {
                link.href = '#';
              }
              tdAddress.appendChild(link);
            }
            tr.appendChild(tdAddress);

            // 分数
            const tdScore = document.createElement('td');
            tdScore.textContent = score;
            tr.appendChild(tdScore);

            tbody.appendChild(tr);
          }
        });

        // 更新汇总数据
        updateSummary();
      } catch (error) {
        console.error('Error loading leaderboard:', error);
      }
    }

    // 分别加载四个排行榜数据
    loadLeaderboard('data/trading.txt', 'tradingTable', 'trading');
    loadLeaderboard('data/staking.txt', 'stakingTable', 'staking');
    loadLeaderboard('data/discord.txt', 'discordTable', 'discord');
    loadLeaderboard('data/xcom.txt', 'xcomTable', 'xcom');

    // 选项卡切换功能
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        // 移除所有按钮 active 样式
        tabBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        // 隐藏所有排行榜 section
        const sections = document.querySelectorAll('.leaderboard-section');
        sections.forEach(sec => sec.style.display = 'none');
        // 显示对应的 section
        const targetId = this.getAttribute('data-target');
        document.getElementById(targetId).style.display = 'block';
        // 重置搜索
        document.getElementById('queryInput').value = '';
        if (targetId !== 'statsSection') {
          resetTable(targetId);
        }
      });
    });

    // 页面加载完成后，默认显示第一个排行榜
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('tradingSection').style.display = 'block';
    });

    // 批量查询：仅针对当前显示的排行榜
    function filterCurrentTable() {
      const query = document.getElementById('queryInput').value.trim().toLowerCase();
      // 找到当前显示的榜单（排除汇总）
      const currentSection = Array.from(document.querySelectorAll('.leaderboard-section'))
                                 .find(s => s.style.display !== 'none' && s.id !== 'statsSection');
      if (!currentSection) return;
      const tbody = currentSection.querySelector('tbody');
      let matchedCount = 0;
      Array.from(tbody.rows).forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(query)) {
          row.style.display = '';
          matchedCount++;
        } else {
          row.style.display = 'none';
        }
      });
      let noDataRow = tbody.querySelector('.no-data');
      if (matchedCount === 0) {
        if (!noDataRow) {
          noDataRow = document.createElement('tr');
          noDataRow.className = 'no-data';
          const td = document.createElement('td');
          td.colSpan = 3; // 3列：排名，地址，分数
          td.textContent = '无';
          noDataRow.appendChild(td);
          tbody.appendChild(noDataRow);
        }
      } else {
        if (noDataRow) noDataRow.remove();
      }
    }

    // 重置当前表格过滤状态（切换选项卡时清除）
    function resetTable(sectionId) {
      const tbody = document.getElementById(sectionId).querySelector('tbody');
      Array.from(tbody.rows).forEach(row => row.style.display = '');
      const noDataRow = tbody.querySelector('.no-data');
      if (noDataRow) noDataRow.remove();
    }

    // 汇总：统计各排行榜的用户数量与总分
    function updateSummary() {
      const tables = [
        { id: 'tradingTable', name: 'TRADING' },
        { id: 'stakingTable', name: 'STAKING' },
        { id: 'discordTable', name: 'DISCORD' },
        { id: 'xcomTable', name: 'X.COM' }
      ];

      let overallUserCount = 0;
      let overallTotalScore = 0;
      let html = `<table border="1" cellspacing="0" cellpadding="6">
                    <thead>
                      <tr>
                        <th>排行榜</th>
                        <th>用户数量</th>
                        <th>总分</th>
                      </tr>
                    </thead>
                    <tbody>`;

      tables.forEach(t => {
        const tbody = document.getElementById(t.id).querySelector('tbody');
        const rows = Array.from(tbody.rows).filter(r => !r.classList.contains('no-data'));
        let userCount = rows.length;
        let totalScore = rows.reduce((sum, row) => {
          const scoreText = row.cells[2]?.textContent || '0';
          return sum + (parseFloat(scoreText) || 0);
        }, 0);

        html += `<tr>
                   <td>${t.name}</td>
                   <td>${userCount}</td>
                   <td>${totalScore}</td>
                 </tr>`;
        overallUserCount += userCount;
        overallTotalScore += totalScore;
      });

      html += `<tr style="font-weight:bold;">
                 <td>总计</td>
                 <td>${overallUserCount}</td>
                 <td>${overallTotalScore}</td>
               </tr>`;
      html += `</tbody></table>`;

      document.getElementById('statsContent').innerHTML = html;
    }
  </script>
</body>
</html>
