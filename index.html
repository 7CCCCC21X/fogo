<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>排行榜</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1, h2 {
      color: #333;
    }
    .tab-nav {
      margin-bottom: 20px;
    }
    .tab-nav button {
      padding: 10px 20px;
      margin-right: 10px;
      border: none;
      background-color: #f5f5f5;
      cursor: pointer;
      border-radius: 4px;
    }
    .tab-nav button.active {
      background-color: #0066cc;
      color: white;
    }
    .search-box {
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f5f5f5;
    }
    .no-data td {
      color: #999;
      font-style: italic;
    }
    /* 默认隐藏所有排行榜 */
    .leaderboard-section {
      display: none;
    }
    /* 统计区域样式 */
    #statsSection {
      margin-top: 30px;
      font-weight: bold;
      font-size: 16px;
    }
    #statsSection table {
      width: auto;
      border-collapse: collapse;
      margin: 0 auto;
    }
    #statsSection th, #statsSection td {
      border: 1px solid #ccc;
      padding: 6px 12px;
      text-align: center;
    }
    #statsSection th {
      background-color: #eee;
    }
    /* 单独的作者链接展示 */
    #authorLink {
      margin-top: 20px;
      font-size: 15px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>排行榜汇总</h1>

  <!-- 选项卡导航 -->
  <div class="tab-nav">
    <button data-target="tradingSection" class="tab-btn active">TRADING</button>
    <button data-target="stakingSection" class="tab-btn">STAKING</button>
    <button data-target="discordSection" class="tab-btn">DISCORD</button>
    <button data-target="xcomSection" class="tab-btn">X.COM</button>
  </div>

  <!-- 批量查询/过滤输入框（仅针对当前显示的排行榜） -->
  <div class="search-box">
    <input type="text" id="queryInput" placeholder="请输入地址或关键词查询..." style="width:300px; padding:8px;">
    <button onclick="filterCurrentTable()">查询</button>
  </div>

  <!-- TRADING排行榜 -->
  <section id="tradingSection" class="leaderboard-section">
    <h2>TRADING</h2>
    <table id="tradingTable">
      <thead>
        <tr>
          <th>排名</th>
          <th>地址</th>
          <th>分数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- STAKING排行榜 -->
  <section id="stakingSection" class="leaderboard-section">
    <h2>STAKING</h2>
    <table id="stakingTable">
      <thead>
        <tr>
          <th>排名</th>
          <th>地址</th>
          <th>分数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- DISCORD排行榜 -->
  <section id="discordSection" class="leaderboard-section">
    <h2>DISCORD</h2>
    <table id="discordTable">
      <thead>
        <tr>
          <th>排名</th>
          <th>地址</th>
          <th>分数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- X.COM排行榜 -->
  <section id="xcomSection" class="leaderboard-section">
    <h2>X.COM</h2>
    <table id="xcomTable">
      <thead>
        <tr>
          <th>排名</th>
          <th>地址</th>
          <th>分数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 数据统计区域 -->
  <h2>数据统计</h2>
  <div id="statsSection"></div>

  <!-- 单独的作者链接展示 -->
  <div id="authorLink">
    作者：<a href="https://x.com/0xXIAOc" target="_blank">小C</a>
  </div>

  <script>
    /**
     * 数据行格式示例：
     * 排名: 1, 地址: 0x9ed15383940cc380faef0a75edace507cc775f22, 分数: 42000
     */
    const lineRegex = /排名:\s*(\d+)\s*,\s*地址:\s*([^,]+)\s*,\s*分数:\s*(\d+)/;

    // 加载并解析单个排行榜数据，提取排名、地址、分数
    async function loadLeaderboard(filePath, tableId) {
      try {
        const response = await fetch(filePath);
        if (!response.ok) {
          throw new Error('无法加载 ' + filePath);
        }
        const text = await response.text();
        const lines = text.trim().split('\n');
        const tbody = document.getElementById(tableId).querySelector('tbody');
        tbody.innerHTML = ''; // 清空原有数据

        lines.forEach(line => {
          const match = line.match(lineRegex);
          if (match) {
            const rank = match[1];
            const address = match[2];
            const score = parseFloat(match[3]);

            const tr = document.createElement('tr');

            // 排名
            const tdRank = document.createElement('td');
            tdRank.textContent = rank;
            tr.appendChild(tdRank);

            // 地址（添加超链接）
            const tdAddress = document.createElement('td');
            const addressLink = document.createElement('a');
            addressLink.textContent = address;
            addressLink.target = "_blank";
            if (tableId === 'tradingTable') {
              addressLink.href = 'https://debank.com/profile/' + address;
            } else if (tableId === 'stakingTable') {
              addressLink.href = 'https://app.getnimbus.io/?tab=token&type=SOL&chain=ALL&address=' + address;
            } else if (tableId === 'xcomTable') {
              addressLink.href = 'https://x.com/' + address;
            } else {
              addressLink.href = '#';
            }
            tdAddress.appendChild(addressLink);
            tr.appendChild(tdAddress);

            // 分数
            const tdScore = document.createElement('td');
            tdScore.textContent = score;
            tr.appendChild(tdScore);

            tbody.appendChild(tr);
          }
        });

        // 加载数据后更新统计数据
        updateStats();
      } catch (error) {
        console.error('Error loading leaderboard:', error);
      }
    }

    // 分别加载四个排行榜数据
    loadLeaderboard('data/trading.txt', 'tradingTable');
    loadLeaderboard('data/staking.txt', 'stakingTable');
    loadLeaderboard('data/discord.txt', 'discordTable');
    loadLeaderboard('data/xcom.txt', 'xcomTable');

    // 选项卡切换功能
    const tabButtons = document.querySelectorAll('.tab-btn');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        tabButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const sections = document.querySelectorAll('.leaderboard-section');
        sections.forEach(section => section.style.display = 'none');
        const targetId = this.getAttribute('data-target');
        document.getElementById(targetId).style.display = 'block';
        document.getElementById('queryInput').value = '';
        resetTable(targetId);
      });
    });

    // 默认显示第一个排行榜
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('tradingSection').style.display = 'block';
    });

    // 批量查询：仅过滤当前显示排行榜数据
    function filterCurrentTable() {
      const query = document.getElementById('queryInput').value.trim().toLowerCase();
      const currentSection = Array.from(document.querySelectorAll('.leaderboard-section'))
                                 .find(section => section.style.display !== 'none');
      if (!currentSection) return;
      const tbody = currentSection.querySelector('table tbody');
      let matchedCount = 0;
      Array.from(tbody.rows).forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(query)) {
          row.style.display = '';
          matchedCount++;
        } else {
          row.style.display = 'none';
        }
      });
      let noDataRow = tbody.querySelector('.no-data');
      if (matchedCount === 0) {
        if (!noDataRow) {
          noDataRow = document.createElement('tr');
          noDataRow.className = 'no-data';
          const td = document.createElement('td');
          td.colSpan = 3; // 3列：排名、地址、分数
          td.textContent = '无';
          noDataRow.appendChild(td);
          tbody.appendChild(noDataRow);
        }
      } else {
        if (noDataRow) {
          noDataRow.remove();
        }
      }
    }

    // 重置当前表格过滤状态（切换选项卡时清除搜索结果）
    function resetTable(sectionId) {
      const tbody = document.getElementById(sectionId).querySelector('table tbody');
      Array.from(tbody.rows).forEach(row => row.style.display = '');
      const noDataRow = tbody.querySelector('.no-data');
      if (noDataRow) { noDataRow.remove(); }
    }

    // 更新统计数据：统计每个排行榜的用户数量与总分，然后渲染到 #statsSection 中
    function updateStats() {
      const tableIds = [
        { id: 'tradingTable', name: 'TRADING' },
        { id: 'stakingTable', name: 'STAKING' },
        { id: 'discordTable', name: 'DISCORD' },
        { id: 'xcomTable', name: 'X.COM' }
      ];
      let statsHTML = '<table><thead><tr><th>排行榜</th><th>用户数量</th><th>总分</th></tr></thead><tbody>';
      let overallUserCount = 0;
      let overallTotalScore = 0;

      tableIds.forEach(item => {
        const table = document.getElementById(item.id);
        const rows = Array.from(table.querySelector('tbody').rows);
        let userCount = 0;
        let totalScore = 0;
        rows.forEach(row => {
          if (row.classList.contains('no-data')) return;
          // 第三列为分数（索引为2）
          const scoreText = row.cells[2]?.textContent || '0';
          const scoreVal = parseFloat(scoreText);
          totalScore += (isNaN(scoreVal) ? 0 : scoreVal);
          userCount++;
        });
        statsHTML += `<tr>
                        <td>${item.name}</td>
                        <td>${userCount}</td>
                        <td>${totalScore}</td>
                      </tr>`;
        overallUserCount += userCount;
        overallTotalScore += totalScore;
      });
      statsHTML += `<tr style="font-weight:bold;">
                      <td>总计</td>
                      <td>${overallUserCount}</td>
                      <td>${overallTotalScore}</td>
                    </tr>`;
      statsHTML += '</tbody></table>';
      document.getElementById('statsSection').innerHTML = statsHTML;
    }
  </script>
</body>
</html>
