<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>排行榜汇总</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .tab-nav {
      margin-bottom: 20px;
    }
    .tab-nav button {
      padding: 10px 20px;
      margin-right: 10px;
      border: none;
      background-color: #f5f5f5;
      cursor: pointer;
      border-radius: 4px;
    }
    .tab-nav button.active {
      background-color: #0066cc;
      color: white;
    }
    .search-box {
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f5f5f5;
    }
    .no-data td {
      color: #999;
      font-style: italic;
    }
    /* 默认隐藏所有排行榜 */
    .leaderboard-section {
      display: none;
    }
  </style>
</head>
<body>
  <h1>排行榜汇总</h1>

  <!-- 选项卡导航，包括四个排行榜 + “汇总”按钮 -->
  <div class="tab-nav">
    <button data-target="tradingSection" class="tab-btn active">TRADING</button>
    <button data-target="stakingSection" class="tab-btn">STAKING</button>
    <button data-target="discordSection" class="tab-btn">DISCORD</button>
    <button data-target="xcomSection" class="tab-btn">X.COM</button>
    <button data-target="statsSection" class="tab-btn">汇总</button>
  </div>

  <!-- 批量查询输入框（仅针对当前显示的排行榜） -->
  <div class="search-box">
    <input type="text" id="queryInput" placeholder="请输入地址或关键词查询..." style="width:300px; padding:8px;">
    <button onclick="filterCurrentTable()">查询</button>
  </div>

  <!-- TRADING 排行榜 -->
  <section id="tradingSection" class="leaderboard-section">
    <table id="tradingTable">
      <thead>
        <tr>
          <th>排名</th>
          <th>地址</th>
          <th>分数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- STAKING 排行榜 -->
  <section id="stakingSection" class="leaderboard-section">
    <table id="stakingTable">
      <thead>
        <tr>
          <th>排名</th>
          <th>地址</th>
          <th>分数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- DISCORD 排行榜 -->
  <section id="discordSection" class="leaderboard-section">
    <table id="discordTable">
      <thead>
        <tr>
          <th>排名</th>
          <th>地址</th>
          <th>分数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- X.COM 排行榜 -->
  <section id="xcomSection" class="leaderboard-section">
    <table id="xcomTable">
      <thead>
        <tr>
          <th>排名</th>
          <th>地址</th>
          <th>分数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- “汇总” 区域（点击“汇总”按钮显示） -->
  <section id="statsSection" class="leaderboard-section">
    <h2>汇总数据</h2>
    <div id="statsContent" style="font-weight: bold; font-size: 16px;"></div>
  </section>

  <script>
    /**
     * 数据行格式示例：
     * 排名: 1, 地址: 0xABCD1234, 分数: 42000
     */
    const lineRegex = /排名:\s*(\d+)\s*,\s*地址:\s*([^,]+)\s*,\s*分数:\s*(\d+)/;

    // 分别加载 4 个排行榜
    loadLeaderboard('data/trading.txt', 'tradingTable', 'trading');
    loadLeaderboard('data/staking.txt', 'stakingTable', 'staking');
    loadLeaderboard('data/discord.txt', 'discordTable', 'discord');
    loadLeaderboard('data/xcom.txt', 'xcomTable', 'xcom');

    async function loadLeaderboard(filePath, tableId, type) {
      try {
        const resp = await fetch(filePath);
        if (!resp.ok) throw new Error('无法加载 ' + filePath);

        const text = await resp.text();
        const lines = text.trim().split('\n');
        const tbody = document.getElementById(tableId).querySelector('tbody');
        tbody.innerHTML = ''; // 清空表格

        lines.forEach(line => {
          const match = line.match(lineRegex);
          if (match) {
            const rank = match[1];
            const address = match[2];
            const score = parseFloat(match[3]);

            const tr = document.createElement('tr');

            // 排名
            const tdRank = document.createElement('td');
            tdRank.textContent = rank;
            tr.appendChild(tdRank);

            // 地址（各榜单地址可自定义链接）
            const tdAddress = document.createElement('td');
            const a = document.createElement('a');
            a.textContent = address;
            a.target = "_blank";
            if (type === 'trading') {
              a.href = 'https://debank.com/profile/' + address;
            } else if (type === 'staking') {
              a.href = 'https://app.getnimbus.io/?tab=token&type=SOL&chain=ALL&address=' + address;
            } else if (type === 'xcom') {
              a.href = 'https://x.com/' + address;
            } else {
              // DISCORD 不跳转
              a.href = '#';
            }
            tdAddress.appendChild(a);
            tr.appendChild(tdAddress);

            // 分数
            const tdScore = document.createElement('td');
            tdScore.textContent = score;
            tr.appendChild(tdScore);

            tbody.appendChild(tr);
          }
        });

        // 数据加载后，更新汇总
        updateSummary();
      } catch (error) {
        console.error(error);
      }
    }

    // 选项卡切换
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        // 移除所有按钮的 active
        tabBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // 隐藏所有 section
        const sections = document.querySelectorAll('.leaderboard-section');
        sections.forEach(sec => sec.style.display = 'none');

        // 显示对应 section
        const targetId = this.getAttribute('data-target');
        document.getElementById(targetId).style.display = 'block';

        // 重置搜索
        document.getElementById('queryInput').value = '';
        if (targetId !== 'statsSection') {
          resetTable(targetId);
        }
      });
    });

    // 页面加载完成后，默认显示第一个排行榜
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('tradingSection').style.display = 'block';
    });

    // 批量查询（仅针对当前显示的排行榜）
    function filterCurrentTable() {
      const query = document.getElementById('queryInput').value.trim().toLowerCase();
      // 找到当前显示的 section
      const currentSection = Array.from(document.querySelectorAll('.leaderboard-section'))
                                 .find(s => s.style.display !== 'none' && s.id !== 'statsSection');
      if (!currentSection) return;

      const tbody = currentSection.querySelector('tbody');
      let matchedCount = 0;
      const rows = Array.from(tbody.rows);

      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(query)) {
          row.style.display = '';
          matchedCount++;
        } else {
          row.style.display = 'none';
        }
      });

      let noDataRow = tbody.querySelector('.no-data');
      if (matchedCount === 0) {
        if (!noDataRow) {
          noDataRow = document.createElement('tr');
          noDataRow.className = 'no-data';
          const td = document.createElement('td');
          td.colSpan = 3; // 3列: 排名,地址,分数
          td.textContent = '无';
          noDataRow.appendChild(td);
          tbody.appendChild(noDataRow);
        }
      } else {
        if (noDataRow) {
          noDataRow.remove();
        }
      }
    }

    // 重置搜索结果
    function resetTable(sectionId) {
      const tbody = document.getElementById(sectionId).querySelector('tbody');
      const rows = Array.from(tbody.rows);
      rows.forEach(row => row.style.display = '');
      const noDataRow = tbody.querySelector('.no-data');
      if (noDataRow) noDataRow.remove();
    }

    // 汇总：统计用户数量和总分
    function updateSummary() {
      const tables = [
        { id: 'tradingTable', name: 'TRADING' },
        { id: 'stakingTable', name: 'STAKING' },
        { id: 'discordTable', name: 'DISCORD' },
        { id: 'xcomTable', name: 'X.COM' }
      ];

      let overallUserCount = 0;
      let overallTotalScore = 0;
      let html = `<table border="1" cellspacing="0" cellpadding="6">
                    <thead><tr><th>排行榜</th><th>用户数</th><th>总分</th></tr></thead><tbody>`;

      tables.forEach(t => {
        const tbody = document.getElementById(t.id).querySelector('tbody');
        const rows = Array.from(tbody.rows).filter(r => !r.classList.contains('no-data'));
        let userCount = 0;
        let totalScore = 0;

        rows.forEach(r => {
          const scoreCell = r.cells[2]?.textContent || '0';
          const scoreVal = parseFloat(scoreCell);
          userCount++;
          if (!isNaN(scoreVal)) totalScore += scoreVal;
        });

        html += `<tr>
                   <td>${t.name}</td>
                   <td>${userCount}</td>
                   <td>${totalScore}</td>
                 </tr>`;

        overallUserCount += userCount;
        overallTotalScore += totalScore;
      });

      html += `<tr style="font-weight:bold;">
                 <td>总计</td>
                 <td>${overallUserCount}</td>
                 <td>${overallTotalScore}</td>
               </tr>`;
      html += `</tbody></table>`;

      document.getElementById('statsContent').innerHTML = html;
    }
  </script>
</body>
</html>
